# ミタマっち – 詳細設計書

> **Version**: Draft 0.2｜2025‑07-12
> **対象 PRD**: «ミタマっち – Product Requirements Document (PRD) v0.1»
> **目的**: PRD で定義された *What* を “How 作るか” へ具体化し、実装フェーズの手戻りを最小限に抑える。

---

## 目次

1.  [アーキテクチャ概要](#アーキテクチャ概要)
2.  [UI設計](#ui設計)
3.  [データフロー](#データフロー)
4.  [インターフェース設計](#インターフェース設計)
5.  [アセット管理](#アセット管理)
6.  [ディレクトリ & ファイル構成](#ディレクトリ--ファイル構成)
7.  [エラーハンドリング](#エラーハンドリング)
8.  [テスト戦略](#テスト戦略)
9.  [実装プラン](#実装プラン)
10. [品質要件マッピング](#品質要件マッピング)

---

## 1. アーキテクチャ概要

（変更なし）

---

## 2. UI設計

### 2.1. UI実装方針

- PhaserのCanvas（ゲーム画面）の上に、HTML要素をオーバーレイしてUIを構築する。
- **理由**: DOM操作に慣れた技術（HTML/CSS）でUIを迅速に実装するため。PhaserのUIコンポーネント学習コストを削減。
- `PlayScene.ts` が `UIController.ts` を呼び出し、UIの表示・非表示・更新を指示する。

### 2.2. 画面レイアウト（ワイヤーフレーム）

```
┌──────────────────────────────────┐
│ Header (z-index: 10)             │
│ ┌──────────┐ ┌───────────┐ │
│ │ ミタマっち   │ │   Soul: 120 │ │
│ └──────────┘ └───────────┘ │
├──────────────────────────────────┤
│                                  │
│ Main Canvas (z-index: 1)         │
│                                  │
│      (ミタマのSprite)            │
│                                  │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│ │ Hungry: 85 │ │ Clean: 70  │ │ Mood: 90   │ │
│ └──────────┘ └──────────┘ └──────────┘ │
│                                  │
├──────────────────────────────────┤
│ Footer (z-index: 10)             │
│ ┌────┐ ┌────┐ ┌────┐ ┌────┐ │
│ │ ごはん │ │ そうじ │ │ あそぶ │ │ シェア │ │
│ └────┘ └────┘ └────┘ └────┘ │
└──────────────────────────────────┘
```

- **Header/Footer**: `position: absolute` を持つHTML要素として実装。
- **メーター類**: Phaser内で描画、もしくはHTML要素としてオーバーレイ。PoCで比較検証する。

---

## 3. データフロー

（変更なし）

---

## 4. インターフェース設計

（変更なし）

---

## 5. アセット管理

### 5.1. 管理方針

- **スプライトシート**: MVPでは使用しない。個別のPNGファイルを動的にロードし、テクスチャを切り替える。
- **理由**: アニメーションが単純なため、スプライトシート作成の手間を省略し、開発速度を優先する。

### 5.2. ファイル命名規則

- 形式: `mitama_{phase}_{state}.png`
- **例**:
    - `mitama_baby_idle.png`
    - `mitama_baby_happy.png`
    - `mitama_junior_sad.png`

---

## 6. ディレクトリ & ファイル構成

| パス | 役割 | 備考 |
| :--- | :--- | :--- |
| `src/scenes/TitleScene.ts` | タイトル画面・タップ待ち | ロゴ表示／クリックで PlayScene へ |
| `src/scenes/PlayScene.ts` | ゲーム本編 | メインループ、`GameLogic`と`UIController`の呼び出し |
| `src/game/GameLogic.ts` | ゲームロジック | 状態管理、メーター計算、進化判定（純粋なロジック） |
| `src/ui/UIController.ts` | UIコントローラー | DOM要素の生成・更新・イベントハンドリング |
| `src/utils/Storage.ts` | localStorageラッパー | `SaveData`の永続化 |
| `src/assets/sprites/*.png` | スプライト画像 | `mitama_baby_idle.png` 等 |
| `src/types/game.d.ts` | 型定義 | `PetPhase`, `SaveData` 等 |

---

## 7. エラーハンドリング

（変更なし）

---

## 8. テスト戦略

- **単体テスト**: `Vitest` を使用し、副作用のない純粋なロジック部分をテストする。
    - **対象**: `src/game/GameLogic.ts`
    - **実行タイミング**: `npm run test` コマンドで手動実行、およびCI連携（将来）。
- **E2Eテスト**: MVPでは手動テストのみ。v1.x以降で `Playwright` 等の導入を検討。

---

## 9. 実装プラン

| ステップ | ゴール | 成果物 / Issue |
| :--- | :--- | :--- |
| 1 | **環境構築** | Viteプロジェクト作成、Phaser・Vitest導入 |
| 2 | **PoC① (UI)** | HTMLボタンでPhaserのログを操作できることを確認 |
| 3 | **PoC② (アセット)** | 卵→ベビーのスプライト切り替え表示を確認 |
| 4 | **本実装：シーン設計** | `TitleScene` と `PlayScene` の雛形を作成 |
| 5 | **本実装：UI実装** | `UIController` でフッターボタンとメーターを仮実装 |
| 6 | **本実装：GameLogic** | `GameLogic.ts` の基本ロジックと単体テストを実装 |
| 7 | **機能統合** | UIボタンと`GameLogic`を連携させ、メーターを増減させる |
| 8 | **進化機能** | 進化ロジックとアセット切り替えを実装 |
| 9 | **永続化** | `Storage.ts` を実装し、ゲーム状態を保存・復元 |
| 10 | **仕上げ** | くすっとイベント、シェア機能、最終調整 |
| 11 | **デプロイ** | GitHub Pagesへデプロイ |

---

## 10. 品質要件マッピング

| 品質特性 | 具体策 |
| :--- | :--- |
| **堅牢性** | try/catch + toast、デフォルトsaveデータ自動生成 |
| **保守性** | 関心事の分離（Scene/Logic/UI）、型定義集中管理 |
| **テスト容易性** | `GameLogic`を純粋なモジュールとして分離し、`Vitest`で単体テスト |
| **運用性** | `console.info`での状態ログ、GitHub Pages Insightsでのアクセス解析 |

---

> **承認依頼**: 上記の更新版設計で実装に移行してよろしいでしょうか？

